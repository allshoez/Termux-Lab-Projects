#!/data/data/com.termux/files/usr/bin/bash

# Warna ANSI
RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
BLUE="\033[0;34m"
PURPLE="\033[0;35m"
CYAN="\033[0;36m"
RESET="\033[0m"

convert_to_mp4() {
    FILE="$1"
    if [[ "$FILE" == *.webm ]]; then
        OUT="${FILE%.webm}.mp4"
        ffmpeg -i "$FILE" -c:v copy -c:a copy "$OUT"
        rm "$FILE"
        echo -e "${GREEN}[â] Konversi ke MP4 â $OUT${RESET}"
    fi
}

while true; do
    clear
    echo -e "${RED}=== ${GREEN}MULTI ${YELLOW}PLATFORM ${BLUE}DOWNLOADER ${PURPLE}TERMUX ===${RESET}"
    echo -e "${YELLOW}1. YouTube Video (best)${RESET}"
    echo -e "${YELLOW}2. YouTube Audio (MP3)${RESET}"
    echo -e "${YELLOW}3. YouTube Video Resolusi tertentu${RESET}"
    echo -e "${YELLOW}4. YouTube Playlist${RESET}"
    echo -e "${YELLOW}5. TikTok Video / Audio${RESET}"
    echo -e "${YELLOW}6. Streaming / Tapepops / Streamtape / m3u8${RESET}"
    echo -e "${YELLOW}7. Update yt-dlp${RESET}"
    echo -e "${YELLOW}8. IG / Facebook Video / Audio${RESET}"
    echo -e "${YELLOW}9. ewa.playerp2p.live${RESET}"
    echo -e "${YELLOW}X. Keluar${RESET}"

    read -p "â¡ï¸ Pilih menu: " menu

    case $menu in
        1)
            read -p "Masukkan URL YouTube: " url
            FILE="/sdcard/Download/%(title)s.%(ext)s"
            yt-dlp -o "$FILE" -f best "$url"
            LAST=$(ls -t /sdcard/Download/* | head -n1)
            convert_to_mp4 "$LAST"
            read -p "[â] Selesai... tekan Enter"
            ;;
        2)
            read -p "Masukkan URL YouTube: " url
            yt-dlp -o "/sdcard/Download/%(title)s.%(ext)s" -f bestaudio --extract-audio --audio-format mp3 "$url"
            read -p "[â] Selesai... tekan Enter"
            ;;
        3)
            read -p "Masukkan URL YouTube: " url
            echo -e "${YELLOW}Pilih resolusi video:${RESET}"
            echo "1. 1080p  2. 720p  3. 480p  4. 360p  5. 240p"
            read -p "â¡ï¸ Pilih: " res
            case $res in
                1) fmt="bestvideo[height<=1080]+bestaudio/best[height<=1080]" ;;
                2) fmt="bestvideo[height<=720]+bestaudio/best[height<=720]" ;;
                3) fmt="bestvideo[height<=480]+bestaudio/best[height<=480]" ;;
                4) fmt="bestvideo[height<=360]+bestaudio/best[height<=360]" ;;
                5) fmt="bestvideo[height<=240]+bestaudio/best[height<=240]" ;;
                *) echo -e "${RED}[!] Pilihan tidak valid!${RESET}"; sleep 1; continue ;;
            esac
            yt-dlp -o "/sdcard/Download/%(title)s.%(ext)s" -f "$fmt" "$url"
            LAST=$(ls -t /sdcard/Download/* | head -n1)
            convert_to_mp4 "$LAST"
            read -p "[â] Selesai... tekan Enter"
            ;;
        4)
            read -p "Masukkan URL Playlist YouTube: " url
            yt-dlp -o "/sdcard/Download/%(playlist_title)s/%(title)s.%(ext)s" "$url"
            for f in /sdcard/Download/*/*.webm; do [ -f "$f" ] && convert_to_mp4 "$f"; done
            read -p "[â] Playlist selesai... tekan Enter"
            ;;
        5)
            read -p "Masukkan URL TikTok: " url
            echo -e "${YELLOW}Pilih format download:${RESET}"
            echo "1. Video (MP4)  2. Audio (MP3)"
            read -p "â¡ï¸ Pilih: " ftype
            case $ftype in
                1) yt-dlp -o "/sdcard/Download/%(title)s.%(ext)s" "$url" ;;
                2) yt-dlp -o "/sdcard/Download/%(title)s.%(ext)s" -f bestaudio --extract-audio --audio-format mp3 "$url" ;;
            esac
            LAST=$(ls -t /sdcard/Download/* | head -n1)
            convert_to_mp4 "$LAST"
            read -p "[â] TikTok selesai... tekan Enter"
            ;;
        6)
            echo -e "${CYAN}Masukkan URL MP4 / m3u8 / Streamtape${RESET}"
            STREAMS=()
            while true; do
                read -p "> " line
                [[ "$line" =~ ^[Xx]$ ]] && exit 0
                [[ -z "$line" ]] && break
                STREAMS+=("$line")
            done
            for S in "${STREAMS[@]}"; do
                F="/sdcard/Download/stream_$(date +%s).mp4"
                if [[ "$S" =~ \.mp4 ]]; then
                    curl -L -A "Mozilla/5.0" "$S" -o "$F"
                elif [[ "$S" =~ \.m3u8 ]]; then
                    ffmpeg -i "$S" -c copy "$F"
                fi
                echo "[â] Selesai: $F"
            done
            read -p "Tekan Enter untuk kembali ke menu"
            ;;
        7)
            pip install -U yt-dlp
            echo -e "${GREEN}[â] Update selesai!${RESET}"
            read -p "Tekan Enter untuk kembali ke menu"
            ;;
        8)
            read -p "Masukkan URL IG / Facebook: " url
            echo "1. Video (MP4)  2. Audio (MP3)"
            read -p "â¡ï¸ Pilih: " ftype
            case $ftype in
                1) yt-dlp -o "/sdcard/Download/%(title)s.%(ext)s" "$url" ;;
                2) yt-dlp -o "/sdcard/Download/%(title)s.%(ext)s" -f bestaudio --extract-audio --audio-format mp3 "$url" ;;
            esac
            LAST=$(ls -t /sdcard/Download/* | head -n1)
            convert_to_mp4 "$LAST"
            read -p "[â] IG/FB selesai... tekan Enter"
            ;;
        9)
            echo "fitur ewa.playerp2p.live tetap sama (langsung MP4)"
            read -p "Tekan Enter untuk kembali ke menu"
            ;;
        x|X)
            echo -e "${GREEN}[â] Keluar...${RESET}"
            exit 0
            ;;
    esac
done